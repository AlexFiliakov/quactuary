<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Optimization Best Practices &#8212; quActuary v0.0.7 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=279e0f84" />
    <script src="../_static/documentation_options.js?v=401b779c"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="https://docs.quactuary.com/user_guide/best_practices.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Numerical Stability Guide" href="numerical_stability.html" />
    <link rel="prev" title="Optimization Configuration Guide" href="configuration_guide.html" />
 
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2TGPCH7PBM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-2TGPCH7PBM');
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="numerical_stability.html" title="Numerical Stability Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="configuration_guide.html" title="Optimization Configuration Guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">quActuary v0.0.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">User Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Optimization Best Practices</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="optimization-best-practices">
<span id="best-practices"></span><h1>Optimization Best Practices<a class="headerlink" href="#optimization-best-practices" title="Link to this heading">¶</a></h1>
<p>This guide presents best practices for using quActuary’s optimization features effectively,
based on real-world use cases and performance testing.</p>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#general-principles" id="id1">General Principles</a></p>
<ul>
<li><p><a class="reference internal" href="#start-simple-optimize-incrementally" id="id2">1. Start Simple, Optimize Incrementally</a></p></li>
<li><p><a class="reference internal" href="#match-optimization-to-problem-size" id="id3">2. Match Optimization to Problem Size</a></p></li>
<li><p><a class="reference internal" href="#consider-total-time-not-just-computation" id="id4">3. Consider Total Time, Not Just Computation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#jit-compilation-best-practices" id="id5">JIT Compilation Best Practices</a></p>
<ul>
<li><p><a class="reference internal" href="#design-jit-friendly-functions" id="id6">Design JIT-Friendly Functions</a></p></li>
<li><p><a class="reference internal" href="#use-type-annotations-for-better-performance" id="id7">Use Type Annotations for Better Performance</a></p></li>
<li><p><a class="reference internal" href="#avoid-jit-compilation-pitfalls" id="id8">Avoid JIT Compilation Pitfalls</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#parallel-processing-best-practices" id="id9">Parallel Processing Best Practices</a></p>
<ul>
<li><p><a class="reference internal" href="#optimize-work-distribution" id="id10">Optimize Work Distribution</a></p></li>
<li><p><a class="reference internal" href="#handle-platform-differences" id="id11">Handle Platform Differences</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#memory-management-best-practices" id="id12">Memory Management Best Practices</a></p>
<ul>
<li><p><a class="reference internal" href="#estimate-memory-requirements" id="id13">Estimate Memory Requirements</a></p></li>
<li><p><a class="reference internal" href="#implement-streaming-for-large-datasets" id="id14">Implement Streaming for Large Datasets</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#qmc-best-practices" id="id15">QMC Best Practices</a></p>
<ul>
<li><p><a class="reference internal" href="#choose-the-right-qmc-engine" id="id16">Choose the Right QMC Engine</a></p></li>
<li><p><a class="reference internal" href="#monitor-qmc-convergence" id="id17">Monitor QMC Convergence</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#production-deployment" id="id18">Production Deployment</a></p>
<ul>
<li><p><a class="reference internal" href="#configuration-management" id="id19">Configuration Management</a></p></li>
<li><p><a class="reference internal" href="#error-handling-and-recovery" id="id20">Error Handling and Recovery</a></p></li>
<li><p><a class="reference internal" href="#performance-monitoring" id="id21">Performance Monitoring</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#next-steps" id="id22">Next Steps</a></p></li>
</ul>
</nav>
<section id="general-principles">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">General Principles</a><a class="headerlink" href="#general-principles" title="Link to this heading">¶</a></h2>
<section id="start-simple-optimize-incrementally">
<h3><a class="toc-backref" href="#id2" role="doc-backlink">1. Start Simple, Optimize Incrementally</a><a class="headerlink" href="#start-simple-optimize-incrementally" title="Link to this heading">¶</a></h3>
<p>Begin with default settings and add optimizations based on profiling:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 1: Baseline with defaults</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="mi">10_000</span><span class="p">)</span>
<span class="n">baseline_time</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">execution_time</span>

<span class="c1"># Step 2: Profile to identify bottlenecks</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">show_profile</span><span class="p">()</span>

<span class="c1"># Step 3: Apply targeted optimizations</span>
<span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">numerical_operations_percent</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">use_jit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Step 4: Measure improvement</span>
<span class="n">speedup</span> <span class="o">=</span> <span class="n">baseline_time</span> <span class="o">/</span> <span class="n">results</span><span class="o">.</span><span class="n">execution_time</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization speedup: </span><span class="si">{</span><span class="n">speedup</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="match-optimization-to-problem-size">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">2. Match Optimization to Problem Size</a><a class="headerlink" href="#match-optimization-to-problem-size" title="Link to this heading">¶</a></h3>
<p>Use this decision matrix:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">select_optimizations</span><span class="p">(</span><span class="n">portfolio_size</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;vectorized&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>  <span class="c1"># Always beneficial</span>

    <span class="c1"># JIT compilation threshold</span>
    <span class="k">if</span> <span class="n">portfolio_size</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="ow">or</span> <span class="n">n_simulations</span> <span class="o">&gt;</span> <span class="mi">50_000</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_jit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Parallel processing threshold</span>
    <span class="k">if</span> <span class="n">portfolio_size</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">n_simulations</span> <span class="o">&gt;</span> <span class="mi">10_000</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;parallel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Memory management threshold</span>
    <span class="n">memory_required_gb</span> <span class="o">=</span> <span class="p">(</span><span class="n">portfolio_size</span> <span class="o">*</span> <span class="n">n_simulations</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
    <span class="k">if</span> <span class="n">memory_required_gb</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;memory_limit_gb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;checkpoint_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_simulations</span> <span class="o">//</span> <span class="mi">100</span>

    <span class="c1"># QMC for high-precision requirements</span>
    <span class="k">if</span> <span class="n">n_simulations</span> <span class="o">&gt;</span> <span class="mi">100_000</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_qmc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">config</span>

<span class="c1"># Apply intelligent defaults</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">select_optimizations</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">portfolio</span><span class="p">),</span> <span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="consider-total-time-not-just-computation">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">3. Consider Total Time, Not Just Computation</a><a class="headerlink" href="#consider-total-time-not-just-computation" title="Link to this heading">¶</a></h3>
<p>Include setup and compilation time in benchmarks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Include all overhead</span>
<span class="n">total_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># First run includes JIT compilation</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">use_jit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">total_start</span>
<span class="n">computation_time</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">execution_time</span>
<span class="n">overhead_time</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">-</span> <span class="n">computation_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time: </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computation: </span><span class="si">{</span><span class="n">computation_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="n">computation_time</span><span class="o">/</span><span class="n">total_time</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overhead: </span><span class="si">{</span><span class="n">overhead_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="n">overhead_time</span><span class="o">/</span><span class="n">total_time</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="jit-compilation-best-practices">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">JIT Compilation Best Practices</a><a class="headerlink" href="#jit-compilation-best-practices" title="Link to this heading">¶</a></h2>
<section id="design-jit-friendly-functions">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Design JIT-Friendly Functions</a><a class="headerlink" href="#design-jit-friendly-functions" title="Link to this heading">¶</a></h3>
<p>Write functions that compile efficiently:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good: JIT-friendly function</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_losses_good</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">severities</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">severities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">losses</span>

<span class="c1"># Bad: JIT-unfriendly function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_losses_bad</span><span class="p">(</span><span class="n">policies</span><span class="p">):</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>  <span class="c1"># Python objects don&#39;t compile</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">policy</span><span class="o">.</span><span class="n">severity</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">limit</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">losses</span>
</pre></div>
</div>
</section>
<section id="use-type-annotations-for-better-performance">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Use Type Annotations for Better Performance</a><a class="headerlink" href="#use-type-annotations-for-better-performance" title="Link to this heading">¶</a></h3>
<p>Help the JIT compiler with type hints:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">float64</span><span class="p">,</span> <span class="n">int32</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span>
    <span class="n">float64</span><span class="p">[:](</span><span class="n">float64</span><span class="p">[:],</span> <span class="n">float64</span><span class="p">[:],</span> <span class="n">float64</span><span class="p">),</span>
    <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_deductible</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">deductibles</span><span class="p">,</span> <span class="n">aggregate_deductible</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply per-occurrence and aggregate deductibles.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
    <span class="n">net_losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">losses</span> <span class="o">-</span> <span class="n">deductibles</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">total_retained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">losses</span> <span class="o">-</span> <span class="n">net_losses</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">total_retained</span> <span class="o">&lt;</span> <span class="n">aggregate_deductible</span><span class="p">:</span>
        <span class="c1"># Apply additional aggregate deductible</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">aggregate_deductible</span> <span class="o">-</span> <span class="n">total_retained</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">net_losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reduction</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">net_losses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">remaining</span><span class="p">)</span>
                <span class="n">net_losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">reduction</span>
                <span class="n">remaining</span> <span class="o">-=</span> <span class="n">reduction</span>
                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="k">return</span> <span class="n">net_losses</span>
</pre></div>
</div>
</section>
<section id="avoid-jit-compilation-pitfalls">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Avoid JIT Compilation Pitfalls</a><a class="headerlink" href="#avoid-jit-compilation-pitfalls" title="Link to this heading">¶</a></h3>
<p>Common issues and solutions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pitfall 1: Python objects in JIT functions</span>
<span class="c1"># Bad</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_policies_bad</span><span class="p">(</span><span class="n">policies</span><span class="p">):</span>  <span class="c1"># List of objects won&#39;t compile</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">]</span>

<span class="c1"># Good</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_policies_good</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>  <span class="c1"># Use arrays instead</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span>

<span class="c1"># Pitfall 2: Dynamic types</span>
<span class="c1"># Bad</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dynamic_bad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>  <span class="c1"># returns float</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;negative&quot;</span>  <span class="c1"># returns string - type inconsistency!</span>

<span class="c1"># Good</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dynamic_good</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>  <span class="c1"># consistent type</span>
</pre></div>
</div>
</section>
</section>
<section id="parallel-processing-best-practices">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Parallel Processing Best Practices</a><a class="headerlink" href="#parallel-processing-best-practices" title="Link to this heading">¶</a></h2>
<section id="optimize-work-distribution">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Optimize Work Distribution</a><a class="headerlink" href="#optimize-work-distribution" title="Link to this heading">¶</a></h3>
<p>Balance work across processes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">optimize_parallel_chunks</span><span class="p">(</span><span class="n">portfolio_size</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">,</span> <span class="n">n_workers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate optimal chunk sizes for parallel processing.&quot;&quot;&quot;</span>

    <span class="c1"># Minimum chunk size to avoid overhead</span>
    <span class="n">min_chunk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_simulations</span> <span class="o">//</span> <span class="p">(</span><span class="n">n_workers</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

    <span class="c1"># Maximum chunk size for good load balancing</span>
    <span class="n">max_chunk</span> <span class="o">=</span> <span class="n">n_simulations</span> <span class="o">//</span> <span class="p">(</span><span class="n">n_workers</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Optimal chunk considering cache efficiency</span>
    <span class="n">optimal_chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_simulations</span> <span class="o">/</span> <span class="n">n_workers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">optimal_chunk</span><span class="p">,</span> <span class="n">min_chunk</span><span class="p">,</span> <span class="n">max_chunk</span><span class="p">)</span>

<span class="c1"># Use optimized chunks</span>
<span class="n">chunk_size</span> <span class="o">=</span> <span class="n">optimize_parallel_chunks</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">portfolio</span><span class="p">),</span>
    <span class="mi">1_000_000</span><span class="p">,</span>
    <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
    <span class="n">n_simulations</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span>
    <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="handle-platform-differences">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Handle Platform Differences</a><a class="headerlink" href="#handle-platform-differences" title="Link to this heading">¶</a></h3>
<p>Account for OS-specific behavior:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Platform-specific optimization settings.&quot;&quot;&quot;</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="c1"># Windows has higher process overhead</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;parallel_threshold&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># Higher threshold</span>
            <span class="s2">&quot;start_method&quot;</span><span class="p">:</span> <span class="s2">&quot;spawn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_workers&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>  <span class="c1"># Limit workers</span>
        <span class="p">}</span>
    <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>  <span class="c1"># macOS</span>
        <span class="c1"># macOS has fork safety issues</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;parallel_threshold&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;start_method&quot;</span><span class="p">:</span> <span class="s2">&quot;spawn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_workers&quot;</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Linux</span>
        <span class="c1"># Linux has efficient forking</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;parallel_threshold&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
            <span class="s2">&quot;start_method&quot;</span><span class="p">:</span> <span class="s2">&quot;fork&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_workers&quot;</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># Apply platform-specific settings</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">get_platform_config</span><span class="p">()</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;parallel_threshold&quot;</span><span class="p">]:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
        <span class="n">n_simulations</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">max_workers</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_workers&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="memory-management-best-practices">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Memory Management Best Practices</a><a class="headerlink" href="#memory-management-best-practices" title="Link to this heading">¶</a></h2>
<section id="estimate-memory-requirements">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Estimate Memory Requirements</a><a class="headerlink" href="#estimate-memory-requirements" title="Link to this heading">¶</a></h3>
<p>Calculate memory needs before running:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">estimate_memory_requirements</span><span class="p">(</span><span class="n">portfolio_size</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate memory requirements in GB.&quot;&quot;&quot;</span>

    <span class="c1"># Base memory per simulation result</span>
    <span class="n">bytes_per_result</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># float64</span>

    <span class="c1"># Account for different arrays needed</span>
    <span class="n">arrays_needed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">portfolio_size</span><span class="p">,</span>
        <span class="s2">&quot;severities&quot;</span><span class="p">:</span> <span class="n">portfolio_size</span><span class="p">,</span>
        <span class="s2">&quot;losses&quot;</span><span class="p">:</span> <span class="n">portfolio_size</span><span class="p">,</span>
        <span class="s2">&quot;net_losses&quot;</span><span class="p">:</span> <span class="n">portfolio_size</span><span class="p">,</span>
        <span class="s2">&quot;aggregated&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="n">total_elements</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">arrays_needed</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">*</span> <span class="n">n_simulations</span>
    <span class="n">base_memory</span> <span class="o">=</span> <span class="n">total_elements</span> <span class="o">*</span> <span class="n">bytes_per_result</span>

    <span class="c1"># Add overhead (temporary arrays, Python objects)</span>
    <span class="n">overhead_factor</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">total_memory_bytes</span> <span class="o">=</span> <span class="n">base_memory</span> <span class="o">*</span> <span class="n">overhead_factor</span>

    <span class="k">return</span> <span class="n">total_memory_bytes</span> <span class="o">/</span> <span class="mf">1e9</span>

<span class="c1"># Check before running</span>
<span class="n">required_gb</span> <span class="o">=</span> <span class="n">estimate_memory_requirements</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">portfolio</span><span class="p">),</span> <span class="mi">10_000_000</span><span class="p">)</span>
<span class="n">available_gb</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">available</span> <span class="o">/</span> <span class="mf">1e9</span>

<span class="k">if</span> <span class="n">required_gb</span> <span class="o">&gt;</span> <span class="n">available_gb</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Need </span><span class="si">{</span><span class="n">required_gb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB, have </span><span class="si">{</span><span class="n">available_gb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enabling memory optimization...&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
        <span class="n">n_simulations</span><span class="o">=</span><span class="mi">10_000_000</span><span class="p">,</span>
        <span class="n">memory_limit_gb</span><span class="o">=</span><span class="n">available_gb</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">100_000</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="mi">10_000_000</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="implement-streaming-for-large-datasets">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Implement Streaming for Large Datasets</a><a class="headerlink" href="#implement-streaming-for-large-datasets" title="Link to this heading">¶</a></h3>
<p>Process data in chunks to manage memory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">simulate_streaming</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100_000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run simulation in memory-efficient chunks.&quot;&quot;&quot;</span>

    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_chunks</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_simulations</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">chunk_size</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chunks</span><span class="p">):</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">)</span>
        <span class="n">chunk_sims</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span>

        <span class="c1"># Process chunk</span>
        <span class="n">chunk_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
            <span class="n">n_simulations</span><span class="o">=</span><span class="n">chunk_sims</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Avoid multiple progress bars</span>
        <span class="p">)</span>

        <span class="c1"># Extract only essential statistics</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">chunk_results</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">chunk_results</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;percentiles&#39;</span><span class="p">:</span> <span class="n">chunk_results</span><span class="o">.</span><span class="n">percentiles</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">])</span>
        <span class="p">})</span>

        <span class="c1"># Force garbage collection between chunks</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Combine results</span>
    <span class="k">return</span> <span class="n">combine_chunk_results</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="qmc-best-practices">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">QMC Best Practices</a><a class="headerlink" href="#qmc-best-practices" title="Link to this heading">¶</a></h2>
<section id="choose-the-right-qmc-engine">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Choose the Right QMC Engine</a><a class="headerlink" href="#choose-the-right-qmc-engine" title="Link to this heading">¶</a></h3>
<p>Select based on problem characteristics:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">select_qmc_engine</span><span class="p">(</span><span class="n">portfolio</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Choose QMC engine based on portfolio characteristics.&quot;&quot;&quot;</span>

    <span class="c1"># Calculate effective dimension</span>
    <span class="n">n_random_variables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># frequency + severity</span>
    <span class="n">has_correlation</span> <span class="o">=</span> <span class="n">portfolio</span><span class="o">.</span><span class="n">correlation_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">n_random_variables</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="c1"># Low dimension - Halton is efficient</span>
        <span class="k">return</span> <span class="s1">&#39;halton&#39;</span>
    <span class="k">elif</span> <span class="n">n_random_variables</span> <span class="o">&lt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_correlation</span><span class="p">:</span>
        <span class="c1"># Medium dimension without correlation - Sobol</span>
        <span class="k">return</span> <span class="s1">&#39;sobol&#39;</span>
    <span class="k">elif</span> <span class="n">has_correlation</span><span class="p">:</span>
        <span class="c1"># Correlation requires special handling</span>
        <span class="k">return</span> <span class="s1">&#39;sobol&#39;</span>  <span class="c1"># With scrambling</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># High dimension - Sobol with dimension reduction</span>
        <span class="k">return</span> <span class="s1">&#39;sobol&#39;</span>

<span class="c1"># Apply intelligent QMC selection</span>
<span class="n">qmc_engine</span> <span class="o">=</span> <span class="n">select_qmc_engine</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
    <span class="n">n_simulations</span><span class="o">=</span><span class="mi">50_000</span><span class="p">,</span>
    <span class="n">use_qmc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">qmc_engine</span><span class="o">=</span><span class="n">qmc_engine</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="monitor-qmc-convergence">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Monitor QMC Convergence</a><a class="headerlink" href="#monitor-qmc-convergence" title="Link to this heading">¶</a></h3>
<p>Track convergence to optimize simulation count:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">monitor_qmc_convergence</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">target_precision</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run QMC with convergence monitoring.&quot;&quot;&quot;</span>

    <span class="n">n_base</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">results_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">power</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>  <span class="c1"># Up to 2^10 * 1000 simulations</span>
        <span class="n">n_sims</span> <span class="o">=</span> <span class="n">n_base</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">power</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
            <span class="n">n_simulations</span><span class="o">=</span><span class="n">n_sims</span><span class="p">,</span>
            <span class="n">use_qmc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>  <span class="c1"># Consistent sequence</span>
        <span class="p">)</span>

        <span class="n">results_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">n_sims</span><span class="p">,</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">results</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;std_error&#39;</span><span class="p">:</span> <span class="n">results</span><span class="o">.</span><span class="n">standard_error</span><span class="p">()</span>
        <span class="p">})</span>

        <span class="c1"># Check convergence</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prev_mean</span> <span class="o">=</span> <span class="n">results_history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
            <span class="n">curr_mean</span> <span class="o">=</span> <span class="n">results_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
            <span class="n">relative_change</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curr_mean</span> <span class="o">-</span> <span class="n">prev_mean</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prev_mean</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">relative_change</span> <span class="o">&lt;</span> <span class="n">target_precision</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged at </span><span class="si">{</span><span class="n">n_sims</span><span class="si">}</span><span class="s2"> simulations&quot;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">results_history</span>
</pre></div>
</div>
</section>
</section>
<section id="production-deployment">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">Production Deployment</a><a class="headerlink" href="#production-deployment" title="Link to this heading">¶</a></h2>
<section id="configuration-management">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Configuration Management</a><a class="headerlink" href="#configuration-management" title="Link to this heading">¶</a></h3>
<p>Use configuration files for production:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># config/optimization.yaml</span>
<span class="nt">development</span><span class="p">:</span>
<span class="w">  </span><span class="nt">use_jit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">parallel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">n_simulations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">  </span><span class="nt">random_state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>

<span class="nt">staging</span><span class="p">:</span>
<span class="w">  </span><span class="nt">use_jit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">parallel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">max_workers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">  </span><span class="nt">n_simulations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100_000</span>
<span class="w">  </span><span class="nt">memory_limit_gb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>

<span class="nt">production</span><span class="p">:</span>
<span class="w">  </span><span class="nt">use_jit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">parallel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">max_workers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w">  </span><span class="c1"># Use all cores</span>
<span class="w">  </span><span class="nt">n_simulations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1_000_000</span>
<span class="w">  </span><span class="nt">memory_limit_gb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w">  </span><span class="c1"># Auto-detect</span>
<span class="w">  </span><span class="nt">use_qmc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">checkpoint_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50_000</span>
</pre></div>
</div>
<p>Load and apply configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_optimization_config</span><span class="p">():</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QUACTUARY_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;development&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;config/optimization.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;development&#39;</span><span class="p">])</span>

<span class="c1"># Use environment-specific configuration</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_optimization_config</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="error-handling-and-recovery">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Error Handling and Recovery</a><a class="headerlink" href="#error-handling-and-recovery" title="Link to this heading">¶</a></h3>
<p>Implement robust error handling:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_simulation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run simulation with comprehensive error handling.&quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">checkpoint_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;checkpoint_</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n_simulations</span><span class="si">}</span><span class="s2">.pkl&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try optimal configuration</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting simulation with </span><span class="si">{</span><span class="n">n_simulations</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="n">n_simulations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">MemoryError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Memory error, switching to streaming mode&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">simulate_streaming</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">mp</span><span class="o">.</span><span class="n">ProcessError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Parallel processing failed, using single process&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">yield</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="n">n_simulations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Simulation interrupted, saving checkpoint&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint saved to </span><span class="si">{</span><span class="n">checkpoint_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Cleanup</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">checkpoint_file</span><span class="p">)</span>

<span class="c1"># Use safe simulation</span>
<span class="k">with</span> <span class="n">safe_simulation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">,</span> <span class="n">use_jit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">results</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation completed: </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="performance-monitoring">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Performance Monitoring</a><a class="headerlink" href="#performance-monitoring" title="Link to this heading">¶</a></h3>
<p>Track performance metrics in production:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceTracker</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">track_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track simulation performance metrics.&quot;&quot;&quot;</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start_memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mf">1e9</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">peak_memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mf">1e9</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;portfolio_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">portfolio</span><span class="p">),</span>
            <span class="s1">&#39;n_simulations&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_simulations&#39;</span><span class="p">],</span>
            <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
            <span class="s1">&#39;memory_used_gb&#39;</span><span class="p">:</span> <span class="n">peak_memory</span> <span class="o">-</span> <span class="n">start_memory</span><span class="p">,</span>
            <span class="s1">&#39;simulations_per_second&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_simulations&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">),</span>
            <span class="s1">&#39;optimizations&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;jit&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_jit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="s1">&#39;parallel&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="s1">&#39;qmc&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_qmc&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_metrics</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save metrics for analysis.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;performance_metrics.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Track production performance</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">track_simulation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">production_config</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="next-steps">
<h2><a class="toc-backref" href="#id22" role="doc-backlink">Next Steps</a><a class="headerlink" href="#next-steps" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../performance/tuning_guide.html"><span class="doc">Advanced Performance Tuning</span></a> - Advanced performance tuning</p></li>
<li><p><a class="reference internal" href="../performance/benchmarks.html"><span class="doc">Performance Benchmarks</span></a> - Performance benchmarks</p></li>
<li><p><a class="reference internal" href="../performance/tuning_guide.html"><span class="doc">Advanced Performance Tuning</span></a> - Performance tuning guide</p></li>
<li><p><a class="reference internal" href="../performance/benchmarks.html"><span class="doc">Performance Benchmarks</span></a> - Performance benchmarks</p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Optimization Best Practices</a><ul>
<li><a class="reference internal" href="#general-principles">General Principles</a><ul>
<li><a class="reference internal" href="#start-simple-optimize-incrementally">1. Start Simple, Optimize Incrementally</a></li>
<li><a class="reference internal" href="#match-optimization-to-problem-size">2. Match Optimization to Problem Size</a></li>
<li><a class="reference internal" href="#consider-total-time-not-just-computation">3. Consider Total Time, Not Just Computation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jit-compilation-best-practices">JIT Compilation Best Practices</a><ul>
<li><a class="reference internal" href="#design-jit-friendly-functions">Design JIT-Friendly Functions</a></li>
<li><a class="reference internal" href="#use-type-annotations-for-better-performance">Use Type Annotations for Better Performance</a></li>
<li><a class="reference internal" href="#avoid-jit-compilation-pitfalls">Avoid JIT Compilation Pitfalls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parallel-processing-best-practices">Parallel Processing Best Practices</a><ul>
<li><a class="reference internal" href="#optimize-work-distribution">Optimize Work Distribution</a></li>
<li><a class="reference internal" href="#handle-platform-differences">Handle Platform Differences</a></li>
</ul>
</li>
<li><a class="reference internal" href="#memory-management-best-practices">Memory Management Best Practices</a><ul>
<li><a class="reference internal" href="#estimate-memory-requirements">Estimate Memory Requirements</a></li>
<li><a class="reference internal" href="#implement-streaming-for-large-datasets">Implement Streaming for Large Datasets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#qmc-best-practices">QMC Best Practices</a><ul>
<li><a class="reference internal" href="#choose-the-right-qmc-engine">Choose the Right QMC Engine</a></li>
<li><a class="reference internal" href="#monitor-qmc-convergence">Monitor QMC Convergence</a></li>
</ul>
</li>
<li><a class="reference internal" href="#production-deployment">Production Deployment</a><ul>
<li><a class="reference internal" href="#configuration-management">Configuration Management</a></li>
<li><a class="reference internal" href="#error-handling-and-recovery">Error Handling and Recovery</a></li>
<li><a class="reference internal" href="#performance-monitoring">Performance Monitoring</a></li>
</ul>
</li>
<li><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="configuration_guide.html"
                          title="previous chapter">Optimization Configuration Guide</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="numerical_stability.html"
                          title="next chapter">Numerical Stability Guide</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/user_guide/best_practices.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="numerical_stability.html" title="Numerical Stability Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="configuration_guide.html" title="Optimization Configuration Guide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">quActuary v0.0.7 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >User Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Optimization Best Practices</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Alex Filiakov, ACAS.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>